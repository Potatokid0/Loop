<!DOCTYPE html>

<html>

<head>

    <script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.js"></script>

</head>

<body>

    <script>
        //test
    var config = {
        type: Phaser.AUTO,
        width: 1200,
        height: 750,
        pixelArt: true,
        physics: {
            default: 'arcade',
        },

        scene: {
            preload: preload,
            create: create,
            update: update,
        }

    };
    

    class Player extends Phaser.Physics.Arcade.Sprite
    {
        totalJumps = 2;
        currentJumps = 0;
        animations;
        isWalking;
        isJumping;
        anom = false;
        onFirst = true;
        pickedAnom = false;
        levelOn = 0;
        constructor(scene, x, y, spritesheet, animations)
        {
            super(scene, x, y, spritesheet);
            this.isWalking = false;
            this.isJumping = false;
            this.animations = animations;
            scene.add.existing(this);
            scene.physics.add.existing(this);
            this.setScale(.5);
            //this.setCollideWorldBounds(true);
            this.setGravityY(3000); //We will set gravity *per object* rather than for the scene!
        }
    }

    class Enemy extends Phaser.Physics.Arcade.Sprite{
        animations;
        constructor(scene, x, y, spritesheet, animations){
            super(scene, x, y, spritesheet);
            this.animations = animations;
            scene.add.existing(this);
            scene.physics.add.existing(this);
            this.setGravityY(3000);
        }
    }


    var game = new Phaser.Game(config);

    //Game Objects
    var platforms;
    var trigger;
    var triggers;
    var basePlatform;
    var newBase;
    var shortPlatforms;
    var player;
    var light;
    var theme
    var ghost;
    var ghostMade;
    var girl;
    var died;

    //Keyboard controls
    var cursors;
    var keys;
    var space;

    //timers
    var walktimer;

    

    function preload()
    {
        this.load.image('hall1', 'assets/hall3.png');
        this.load.image('level', 'assets/LevelHallway.png');
        this.load.image('platform', 'assets/platform2.png');
        this.load.image('tim', 'assets/tim_anims/tim.png');
        this.load.image('black', 'assets/black.jpg');
        this.load.image('light', 'assets/lighting.png');
        this.load.image('platlock', 'assets/LockerPlatform.png');
        this.load.image('sidelocker', 'assets/lockerside.png');
        this.load.image('shelf', 'assets/shelf.png');
        this.load.image('bookshelf', 'assets/bookshelf.png');
        this.load.atlas('tim_idle', 'assets/tim_anims/idle.png', 'assets/tim_anims/idle.json');
        this.load.atlas('tim_jump', 'assets/tim_anims/jump.png', 'assets/tim_anims/jump.json');
        this.load.atlas('tim_walk', 'assets/tim_anims/walk.png', 'assets/tim_anims/walk.json');
        this.load.audio('theme', 'music/maintheme.wav')
        this.load.image('girl', 'assets/girl.webp')
        this.load.atlas('tim_idle', 'assets/tim_anims/idle.png', 'assets/tim_anims/idle.json');
        this.load.atlas('tim_jump', 'assets/tim_anims/jump.png', 'assets/tim_anims/jump.json');
        this.load.atlas('tim_walk', 'assets/tim_anims/walk.png', 'assets/tim_anims/walk.json');
        this.load.atlas('ghost', 'assets/ghost.png', 'assets/ghost.json');
    }

    function create()
    {

        //plays music
        let theme = this.add.audio('theme');
        const music = this.sound.add('theme');
        loop = true;
        music.play();

       //hallway
       let background = this.add.image(0, 0, 'hall1').setOrigin(0, 0);
        background.setScale(5);
       
       //level
       let level = this.add.image(3750, 750, 'level').setOrigin(0, 0);
        level.setScale(5); 
        
       //anims
       let playerAnimations = {};
       var idle = this.anims.create({key: 'tim_idle', frames: this.anims.generateFrameNames('tim_idle', {prefix: 'pixil-frame-', end: 6, zeroPad: 1}), repeat: -1, frameRate: 6});
       playerAnimations['idle'] = idle;
       var jump = this.anims.create({key: 'tim_jump', frames: this.anims.generateFrameNames('tim_jump', {prefix: 'pixil-frame-', end: 7, zeroPad: 1}), repeat: 1, frameRate: 10  });
       playerAnimations['jump'] = jump; 
       var walk = this.anims.create({key: 'tim_walk', frames: this.anims.generateFrameNames('tim_walk', {prefix: 'pixil-frame-', end: 11, zeroPad: 1}), repeat: 1, frameRate: 11});
       playerAnimations['walk'] = walk; 
       
       let ghostAnimations= {};
       var ghostWalk = this.anims.create({key: 'ghost', frames: this.anims.generateFrameNames('ghost', {prefix: 'pixil-frame-', end: 14, zeroPad: 1}), repeat: -1, frameRate: 9});
       ghostAnimations['walk'] = ghostWalk; 

       //lighting
       let black = this.add.image(0, 0, 'black').setOrigin(0,0);
       black.setScale(100);
       black.setAlpha(.85);

       light = this.add.image(0,0, 'light');
       light.setScale(15);
       light.setAlpha(.60);
       //light.setBlendMode('EXCLUSION'); 

       //floor
       createPlatforms(this);
       player = new Player(this, 400, 400, 'tim', playerAnimations);
       player.setScale(15)
       this.physics.add.collider(player, platforms);
       player.play(player.animations['idle']);


       //Set up user input
       cursors = this.input.keyboard.createCursorKeys();
       keys = this.input.keyboard.addKeys('A, D');
       space = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE);
       space.on('down', jumpFunction); //calls jump function when space is pressed
       
       this.cameras.main.setBounds(0, 0, 4300, 750);
       this.cameras.main.startFollow(player, true, 0.50, 0.05);

       died = false;
       this.physics.add.overlap(player, triggers, function() {
           fall();
           this.cameras.main.setBounds(3700,0, 4850, 2750);
           newBase = platforms.create(3750, 2750, 'platform');
           newBase.setScale(25, 1).refreshBody(); //scales the base platform in the x axis to cover the entire floor
           newBase.setVisible(false);
           nextLevel(1, this);
           ghost = new Enemy(this, 6000, 2000, 'ghost', ghostAnimations);
           this.physics.add.collider(ghost, platforms);
           ghost.play(ghost.animations['walk'], true);
           ghost.setScale(10);
           ghost.setDepth(4);
           black.setDepth(5);
           light.setDepth(6);
           player.setDepth(7);
           ghostMade = true;
           this.physics.add.overlap(player, ghost, function (){
               girl = this.add.image(player.x, player.y - 250, 'girl');
               girl.setScale(2);
               girl.setDepth(8);
               died = true;
               this.cameras.main.startFollow(player, true, 1, 1);
           }, null, this);
        }, null, this);

       
    }

    
    function bookRoom (){
        //first level, no anoms so always the correct answer is no anoms
        //load bookroom
        if (player.onFirst === true){
            player.onFirst = false;
            if (player.pickedAnom === false){
                //random if actual nextLevel or if anom level
                //call nextLevel 1
            }
        }
        else {
            //check player .levelOn and add +1 if randomly nextLevel or base the anom level on it
            //see if player picked correct
        }
    }

    function anomLevel(){
        //check player.levelOn
        //randomly put assets in certain places
        //set player.anom
    }

    function nextLevel(num, scene){
        //4 enemies, enemies are not anomelies... so basically randomly if your left was diff or not
        if (num === 1)
        {

            shortPlatforms = platforms.create(4400, 2450, 'shelf');
            shortPlatforms.setScale(4,2).refreshBody();

            shortPlatforms = platforms.create(5000, 2250, 'shelf');
            shortPlatforms.setScale(4,2).refreshBody();

            shortPlatforms = platforms.create(5900, 2450, 'shelf');
            shortPlatforms.setScale(4,2).refreshBody();

            shortPlatforms = platforms.create(6500, 2450, 'shelf');
            shortPlatforms.setScale(4,2).refreshBody();

            shortPlatforms = platforms.create(5900, 2050, 'shelf');
            shortPlatforms.setScale(6,2).refreshBody();
            shortPlatforms = platforms.create(6200, 2050, 'shelf');
            shortPlatforms.setScale(6,2).refreshBody();
            shortPlatforms = platforms.create(6500, 2050, 'shelf');
            shortPlatforms.setScale(6,2).refreshBody();

            shortPlatforms = platforms.create(5000, 2250, 'shelf');
            shortPlatforms.setScale(4,2).refreshBody();

            shortPlatforms = platforms.create(7300, 2150, 'shelf');
            shortPlatforms.setScale(4,2).refreshBody();

            shortPlatforms = platforms.create(7900, 2450, 'shelf');
            shortPlatforms.setScale(4,2).refreshBody();

            shortPlatforms = platforms.create(6200, 1700, 'shelf');
            shortPlatforms.setScale(6,2).refreshBody();
            shortPlatforms = platforms.create(6500, 1700, 'shelf');
            shortPlatforms.setScale(6,2).refreshBody();
            shortPlatforms = platforms.create(6800, 1700, 'shelf');
            shortPlatforms.setScale(6,2).refreshBody();

            shortPlatforms = platforms.create(7900, 1875, 'shelf');
            shortPlatforms.setScale(6,2).refreshBody();
            shortPlatforms = platforms.create(8200, 1875, 'shelf');
            shortPlatforms.setScale(6,2).refreshBody();

            shortPlatforms = platforms.create(7500, 1500, 'shelf');
            shortPlatforms.setScale(4,2).refreshBody();

            shortPlatforms = platforms.create(7900, 1200, 'shelf');
            shortPlatforms.setScale(4,2).refreshBody();

            shortPlatforms = platforms.create(7000, 1200, 'shelf');
            shortPlatforms.setScale(4,2).refreshBody();

            shortPlatforms = platforms.create(8300, 1000, 'shelf');
            shortPlatforms.setScale(4,2).refreshBody();

            shortPlatforms = platforms.create(6200, 1200, 'shelf');
            shortPlatforms.setScale(6,2).refreshBody();
            shortPlatforms = platforms.create(6300, 1200, 'shelf');
            shortPlatforms.setScale(6,2).refreshBody();
            
            shortPlatforms = platforms.create(5000, 1875, 'shelf');
            shortPlatforms.setScale(4,2).refreshBody();

            shortPlatforms = platforms.create(4400, 1600, 'shelf');
            shortPlatforms.setScale(4,2).refreshBody();

            shortPlatforms = platforms.create(5000, 1400, 'shelf');
            shortPlatforms.setScale(4,2).refreshBody();

            shortPlatforms = platforms.create(6600, 900, 'shelf');
            shortPlatforms.setScale(4,2).refreshBody();

        }
        else if (num === 2){

        }
        else if (num === 3){

        }
        else if (num === 4){

        }
        else if (num === 5){

        }
        else if (num === 6){

        }
        else {
            //ex num === 0
        }
    }

    function death (){
        //disableBody of all characters
        //gui saying DEATH
        //after enemy (most) touches player or if picked wrong option in bookRoom
    }

    function createPlatforms(scene)
    {
        platforms = scene.physics.add.staticGroup();
        triggers = scene.physics.add.staticGroup();
        //basePlatform is the floor of the game
        basePlatform = platforms.create(game.scale.width/2, game.scale.height-15, 'platform');
        basePlatform.setScale(15, 1).refreshBody(); //scales the base platform in the x axis to cover the entire floor
        basePlatform.setVisible(false);
        
        trigger = triggers.create(4250, game.scale.height-15, 'platform');
        trigger.setScale(2, 3);
        trigger.refreshBody();
        trigger.setVisible(false);
    }

    function update()
    {
        //Player will not move in the x-axis unless a movement key is being pressed
        player.setVelocityX(0);

        //ghost
        if (ghostMade){
            this.physics.moveToObject(ghost, player, 400);
            if (ghost.body.velocity.x < 0){
                ghost.flipX = true;
            }
            else {
                ghost.flipX = false;
            }
            if (died){
                player.disableBody(true);
            }
        }
        //lighting
        light.setX(player.x);
        light.setY(player.y);
        //Player has "drag" on the x-axis meaning they slide a bit after an input
        player.setDragX(1000);

        if (player.body.velocity.x === 0){
            player.isWalking = false;
        }


        //This will reset the number of jumps available to the player whenever the player lands
        if (player.body.touching.down) {
            player.currentJumps = 0;
            player.isJumping = false;
        }
        
        //Handle player movements
        if (cursors.left.isDown || keys.A.isDown)
        {
            player.isWalking = true;
            player.flipX = true;
            if (!player.isJumping){
                player.play(player.animations['walk'], true);
            }
            player.setVelocityX(-600);
        }
        

        if (cursors.right.isDown || keys.D.isDown)
        {
            player.flipX = false;
            player.isWalking = true;
            if (!player.isJumping){
                player.play(player.animations['walk'], true);
            }
            player.setVelocityX(600);
            
        }
        
        if (!player.isWalking && !player.isJumping){
            player.play(player.animations['idle'], true);
        }
        
    }

    function jumpFunction(event)
    {
        player.play(player.animations['jump'], true);
        player.isJumping = true;
        if (player.body.touching.down) {
          //If the player is on the ground, the player can jump
          player.setVelocityY(-1325);
          player.currentJumps++;
        } else if (player.currentJumps < player.totalJumps) {
          //If the player is not on the ground but has an available air jump, use that jump
          player.setVelocityY(-800);
          if (player.flipX === false){
            player.setVelocityX(player.body.velocity.x + 1500);
          }
          else{
            player.setVelocityX(player.body.velocity.x -1500);
          }
          player.currentJumps++;
        }
    }
    function fall(event){
        trigger.disableBody(true, true);
        basePlatform.disableBody(true, true);
        console.log("fell")
    }
    

    </script>

</body>

</html>
